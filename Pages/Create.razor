@page "/Create"

@using Srs.Data
@inject Srs.Service Service
@inject NavigationManager Navigation

<div class="container">
	<div class="row justify-content-center">

		@if (Service.ConnectionId == null) Navigation.NavigateTo("/");

		<!-- Deck -->
		<div class="col" align="center">
			<span class="text-header">Deck</span>

			<!-- Notification -->
			<div class="row justify-content-center">
                @if (createMsgTitle != null)
            	{	
                <div class="alert @createMsgType alert-dismissible fade show" role="alert" align="center">
                    <strong>@createMsgTitle</strong><br>@createMsg
                    <button type="button" class="close btn-sm" @onclick="(()=>SetCreateNotification())" aria-label="Close">&times;</button>
                </div>
            	}
			</div>

			<!-- Name -->
			<div class="input-group input-group-sm mt-2">
	 			<div class="input-group-prepend">
    				<span class="input-group-text bi bi-stack"></span>
    			</div>
				<input type="text" class="form-control rounded-right" placeholder="Name" @bind="newDeck.Name" aria-label="Deck name">
			</div>

			<!-- User -->
			<div class="input-group input-group-sm mt-2">
				<div class="input-group-prepend">
			    	<span class="input-group-text bi bi-people-fill rounded-left"></span>
			    </div>
				<input type="text" class="form-control rounded-right" placeholder="Users" disabled>

				<!-- User tooltip -->
  				<button class="btn btn-sm dropdown btn-tooltip" tabindex="-1">
					<div class="dropdown">
						<div class="dropdown-menu dropdown-menu-tooltip-center">
							<span class="dropdown-item text-tooltip disabled">!! Currently disabled !!</span>
							<span class="dropdown-item text-tooltip disabled">Seperate multiple users with comma</span>
							<span class="dropdown-item text-tooltip disabled">(e.g. user1,user2)</span>
						</div>
					</div>
					<span class="dropdown bi bi-question-circle"></span>
				</button>
			</div>

			<!-- Password -->
			<div class="input-group input-group-sm mt-2">
	 			<div class="input-group-prepend">
    				<span class="input-group-text bi bi-lock-fill"></span>
    			</div>
				<input type="text" class="form-control rounded-right" placeholder="Password" @bind="newDeck.Password" disabled>
				
				<!-- Password tooltip -->
  				<button class="btn btn-sm dropdown btn-tooltip" tabindex="-1">
					<div class="dropdown">
						<div class="dropdown-menu dropdown-menu-tooltip-center">
							<span class="dropdown-item text-tooltip disabled">!! Currently disabled !!</span>
						<span class="dropdown-item text-tooltip disabled">Password required to open deck</span>
						</div>
					</div>
					<span class="dropdown bi bi-question-circle"></span>
				</button>
			</div>

			<!-- Create -->
			<div class="row justify-content-center">
				<button class="btn btn-accept" type="button" @onclick="(() => CreateDeck())">Create Deck</button>
			</div>
		</div>

		<!-- Card -->
		<div class="col" align="center">
			<span class="text-header">Card</span>

			<!-- Card front -->
			<div class="input-group input-group-sm mt-2">
				<textarea class="form-control text-center rounded-right" maxlength="50" rows="3" placeholder="Front of the card" @bind="newCard.Front"></textarea>

				<!-- Front tooltip -->
  				<button class="btn btn-sm dropdown btn-tooltip" tabindex="-1">
					<div class="dropdown">
						<div class="dropdown-menu dropdown-menu-tooltip-left">
							<span class="dropdown-item text-tooltip disabled">Front text for the card</span>
							<span class="dropdown-item text-tooltip disabled">Limited currently to 50 characters</span>
						</div>
					</div>
					<span class="dropdown bi bi-question-circle"></span>
				</button>
			</div>

			<!-- Card back -->
			<div class="input-group  input-group-sm mt-2">
				<textarea class="form-control text-center rounded-right" maxlength="50" rows="3" placeholder="Back of the card" @bind="newCard.Back" @bind:event="oninput" @onkeydown="Enter"></textarea>

				<!-- Back tooltip -->
  				<button class="btn btn-sm dropdown btn-tooltip" tabindex="-1">
					<div class="dropdown">
						<div class="dropdown-menu dropdown-menu-tooltip-left">
							<span class="dropdown-item text-tooltip disabled">Front text for the card</span>
							<span class="dropdown-item text-tooltip disabled">Limited currently to 50 characters</span>
						</div>
					</div>
					<span class="dropdown bi bi-question-circle"></span>
				</button>
			</div>

			<!-- Card action -->
			<div class="row justify-content-center">
				<button class="btn btn-accept" type="button" @onclick="(() => SaveCard())">Save Card</button>
			</div>
		</div>
	</div>

	<!-- Card list header -->
	<div class="row justify-content-center mt-2">
		<span class="text-header">Card list</span>
	</div>

	<!-- Search -->
	<div class="row mt-2">
		<div class="input-group justify-content-center">
			<input type="search" class="form-control rounded-left" placeholder="What are you looking for?" @bind-value="deckSearch" @bind-value:event="oninput" aria-label="Search">
		</div>
	</div>

	<!-- Table -->
	<div class="row justify-content-center mt-2">
		<table class="table table-new table-sm">
			<colgroup>
				<col span="1" style="width: 45%;">
       			<col span="1" style="width: 45%;">
				<col span="1" style="width: 10%;"> 
			</colgroup>

			<!-- Sort -->
			<thead>
				<tr>

				<!-- Sort by front -->
      				<th scope="col">
						<div class="btn-group" role="group" aria-label="Sort by popularity">
							@if (listSort == 1 || listSort == 2) {
								<button class="btn btn-sort btn-active text-left" @onclick="(() => ToggleSort(1))" type="button">Front
									@if (listSort == 1) { <span class="bi bi-sort-alpha-down"></span> }
									else if (listSort == 2) { <span class="bi bi-sort-alpha-up"></span> }
								</button>
							}
							else {
								<button class="btn btn-sort text-left" @onclick="(() => ToggleSort(1))" type="button">Front
									<span class="bi bi-sort-alpha-up btn-inactive"></span>
								</button>
							}
						</div>
					</th>

					<!-- Sort by back -->
      				<th scope="col">
						<div class="btn-group" role="group" aria-label="Sort by name">
							@if (listSort == 3 || listSort == 4) {
								<button class="btn btn-sort btn-active text-left" @onclick="(() => ToggleSort(3))" type="button">Back
									@if (listSort == 3) { <span class="bi bi-sort-alpha-down"></span> }
									else if (listSort == 4) { <span class="bi bi-sort-alpha-up"></span> }
								</button>
							}
							else {
								<button class="btn btn-sort text-left" @onclick="(() => ToggleSort(3))" type="button">Back
									<span class="bi bi-sort-alpha-up btn-inactive"></span>
								</button>
							}
						</div>
					</th>

					<!-- Action -->
					<th scope="col" class="text-center">
						<span class="btn btn-sort">Action</span>
					</th>
				</tr>
			</thead>

			<!-- List -->
			<tbody>
				@if (sortedList == null) { ToggleSort(-1); }
				@foreach (Card item in sortedList)
				{

					// Search
					if (!item.Front.Contains(deckSearch, StringComparison.CurrentCultureIgnoreCase) && 
						!item.Back.Contains(deckSearch, StringComparison.CurrentCultureIgnoreCase)) continue;

					<tr>
		    			<td class="text-left overflow-hidden">@item.Front</td>
      					<td class="text-left overflow-hidden">@item.Back</td>
     					<td class="text-right">
                        	<button class="btn btn-sm btn-select" type="button" @onclick="(() => EditCard(item))">
								<img src="svg/Edit.svg" alt="" width="16" height="16" title="Edit">
							</button>
							<button class="btn btn-sm btn-select" type="button" @onclick="(() => DeleteCard(item))">
								<img src="svg/Delete.svg" alt="" width="16" height="16" title="Delete">
							</button>
						</td>
    				</tr>
				}
  			</tbody>
		</table>
	</div>
</div>

@code
{
	private int listSort, editCard;
	private string createMsgTitle, createMsg, createMsgType;
	private string deckSearch = "";
	private DeckFull newDeck = new DeckFull {Cards = new SortedDictionary<int, Card>()};
	private Data.Card newCard = new Data.Card();
	private List<Card> sortedList = new List<Card>();
	
	private void ToggleSort(int input) {
		if (listSort == 0) listSort = input;
		else if (listSort == input) listSort += 1;
		else if (listSort == input + 1) listSort = 0;
		else if (input != -1) listSort = input;

		switch (listSort) {
			case 0: sortedList = newDeck.Cards.Values.ToList(); break;
			case 1: sortedList = newDeck.Cards.Values.OrderBy(x => x.Front).ToList(); break;
			case 2: sortedList = newDeck.Cards.Values.OrderByDescending(x => x.Front).ToList(); break;
			case 3: sortedList = newDeck.Cards.Values.OrderBy(x => x.Front).ToList(); break;
			case 4: sortedList = newDeck.Cards.Values.OrderByDescending(x => x.Front).ToList(); break;
			default: sortedList = newDeck.Cards.Values.ToList(); break;
		}
	}

	private void SetCreateNotification(string title = null, string msg = null, string type = "warning") {
        createMsgTitle = title;
        createMsg = msg;
        createMsgType = "alert-" + type;
    }

	private void SaveCard() {
		if (newDeck.Cards.Count == 0) { newCard.Id = 1; newDeck.Cards.Add(newCard.Id, newCard); }
		else if (newCard.Id == 0) { newCard.Id = newDeck.Cards.Keys.Last() + 1; newDeck.Cards.Add(newCard.Id, newCard); }
		else { newDeck.Cards[editCard] = newCard; }
		newCard = new Data.Card();
		ToggleSort(-1);
	}

	private void EditCard(Data.Card card) {
		editCard = card.Id;
		newCard = card;
		ToggleSort(-1);
	}

	private void DeleteCard(Data.Card card) {
		newDeck.Cards.Remove(card.Id);
		ToggleSort(-1);
	}

	private async Task CreateDeck() {
		Service.DeckCreateAsync(newDeck);
	}

	// Enter to save card
    private void Enter(KeyboardEventArgs e) {
        if ((e.Code == "Enter" || e.Code == "NumpadEnter") && e.ShiftKey == false) SaveCard();
    }
}